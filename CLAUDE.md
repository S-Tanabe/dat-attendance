# Dashboard Accelerator Template - 開発ルール

**最終更新**: 2025-11-13

---

## 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [ドキュメント体系](#ドキュメント体系)
3. [CRITICAL RULES - 絶対に守るべきルール](#critical-rules---絶対に守るべきルール)
4. [実装開始前の強制プロセス](#実装開始前の強制プロセス)
5. [MCP優先使用ルール](#mcp優先使用ルール)
6. [技術スタック](#技術スタック)
7. [プロジェクト構成](#プロジェクト構成)
8. [Skills体系](#skills体系)
9. [例外処理とエスカレーション](#例外処理とエスカレーション)

---

## プロジェクト概要

このプロジェクトは **dashboard-accelerator テンプレート** 上に構築されています。

### テンプレートが提供する機能

dashboard-acceleratorは管理画面系に特化したテンプレートで、以下の機能を予め実装済みです：

- **認証・認可システム** (JWT + Session + RBAC)
- **通知システム** (SSE リアルタイム通知)
- **基本UIレイアウト** (Header, Sidebar, Toast)
- **APIラッパー** (自動リフレッシュ、エラーハンドリング統合)
- **統一エラーハンドリング** (Backend + Frontend)
- **データベース設計パターン** (スキーマ分割、高度検索)
- **品質チェック機構** (ESLint + SvelteCheck + pre-commit hooks)
- **監視・ロギング** (Sentry統合)

### 重要な原則

**このテンプレートは既存機能を最大限活用することを前提としています。**

- ✅ **既存機能を最初に確認する**
- ✅ **既存実装パターンを踏襲する**
- ✅ **テンプレート制約に従って実装する**
- ❌ **既存機能を削除してはいけない**
- ❌ **テンプレートの代替手段を使ってはいけない**

---

## ドキュメント体系

このプロジェクトでは目的別に整理されたドキュメント体系を採用しています。

### Level 1: エントリーポイント（概要レベル）

| ドキュメント | 内容 | いつ読むか |
|------------|------|--------|
| **CLAUDE.md (本ドキュメント)** | 開発ルール・制限事項・技術スタック | 開発開始前（必須） |
| **ACCELERATOR.md** | テンプレート機能説明・アーキテクチャ・設計原則 | 開発開始前（必須） |
| **README.md** | プロジェクト概要・セットアップガイド | 初回セットアップ時 |

### Level 2: 領域別開発ルール

| ドキュメント | 内容 | いつ読むか |
|------------|------|--------|
| **backend/CLAUDE.md** | Backend開発ルール・ワークフロー | Backend実装時 |
| **frontend-admin/CLAUDE.md** | 管理画面Frontend開発ルール・ワークフロー | 管理画面実装時 |

### ドキュメントの読み方

1. **必ず最初に**: `CLAUDE.md`（本ドキュメント）と `ACCELERATOR.md`
2. **領域別に**: Backend実装時は `backend/CLAUDE.md`、Frontend実装時は `frontend-admin/CLAUDE.md`
3. **Frontend分離計画**: `docs/FRONTEND_SEPARATION_PLAN.md` で構成を理解

---

## CRITICAL RULES - 絶対に守るべきルール

これらのルールは**いかなる理由があっても守らなければならない**。
違反した場合は即座に作業を停止し、ユーザーに報告すること。

### 1. 削除禁止・git checkout 禁止ルール

**判断フロー：既存機能を削除・無効化したいとき**

```
削除要求が来た
↓
ユーザーが「明示的に削除指示」している？
├─ YES → 許可（ただし確認報告必須）
└─ NO ↓
「エラー回避」「簡略化」が理由？
├─ YES → ❌ 禁止。根本原因を修正
└─ NO ↓
機能が必要だが新要求と衝突している？
├─ YES → ✅ 別画面/オプション/切り替え実装
└─ NO → ❌ 禁止。報告して相談
```

**禁止される行為:**

- ❌ エラーが出た機能の削除
- ❌ 自分のコミット履歴以外の `git checkout`
- ❌ 新しい要求によって以前の UI や機能を削除
- ❌ 「簡略化」と称した機能減少
- ❌ 「リファクタリング」での機能省略
- ❌ 一時的な回避としての機能無効化
- ❌ 追加に関係のない部分の破壊

**必須の対応:**

- ✅ エラーの根本原因を特定（機能は保持）
- ✅ 機能を維持したまま修正
- ✅ 機能や UI が衝突する場合はサンプル用の別画面を用意
- ✅ できない場合は代替実装を提案
- ✅ それでも無理なら **ユーザーに報告 + 実装の可否判断を依頼**

### 2. ESLint ルール違反禁止ルール

**禁止される行為:**

- ❌ ESLint のルール設定そのものを変更
- ❌ `eslint-disable-next-line` の使用
- ❌ エラーやワーニングを無視する修正

**必須の対応:**

- ✅ 確実に修正を行う
- ✅ 最初にルールを理解して開発する
- ✅ 他の機能がどのように実装されているか参考にし適切に修正
- ✅ 修正は機能を破壊しないように細心の注意を払う
- ✅ 影響が出る可能性がある場合はユーザーに相談

### 3. 代替手段禁止ルール

**禁止される行為:**

- ❌ 定められた以外のバージョンやツールを勝手に切り替えない
  - 例: Tailwind v4 を v3 に切り替える
  - 例: mecab-wasm を kuromoji に切り替える
- ❌ 新しい要求が来ても以前の実装を上書きしない
- ❌ エラーを理由に別の実装に切り替えない

**必須の対応:**

- ✅ エラーの解消方法を追求する
- ✅ エラーが解消できない場合は、代替案を提案しメリット・デメリットを説明
- ✅ 自分で解消できないエラーは必ず相談

### 4. 未回答作業禁止ルール

**禁止される行為:**

- ❌ 質問をされた場合、勝手に作業を始めない
- ❌ 回答したからと言って勝手に作業を始めない
- ❌ 「以前の機能を消したのか?」と聞かれた場合に、消しているのに実装によって復元することで誤魔化さない

**必須の対応:**

- ✅ 質問には回答のみ出力する
- ✅ 回答が正しいことや、質問の意図を推測する
- ✅ 回答のエビデンスや状況の経緯を説明する

---

## 実装開始前の強制プロセス

**全ての実装タスクを開始する前に、以下の順序で必ず実施してから「了解した」と出力してください：**

### ☑️ 実装前チェックリスト

```checklist
□ Step 1: テンプレート機能の確認
  - ACCELERATOR.md で既存機能を確認
  - 実装しようとしている機能がテンプレートで提供済みか確認
  - 提供済みの場合、既存実装を最大限活用

□ Step 2: プロジェクト構造の確認
  - Serena MCP でシンボル検索、または `tree -L 3` で構成確認
  - 実装ディレクトリを特定

□ Step 3: 依存関係ファイルの確認
  - `package.json`, `pyproject.toml` 等を読む
  - ライブラリバージョンを記憶

□ Step 4: ドキュメントの確認
  - Backend実装時: backend/CLAUDE.md で開発ルールを確認
  - Frontend実装時: frontend/CLAUDE.md で開発ルールを確認
  - ACCELERATOR.md で実装パターンを確認

□ Step 5: 既存実装パターンの確認
  - 類似機能や同じ領域の既存コードを検索
  - 共通言語・命名規則・ファイル構成を理解
  - Context7 MCP で「ベストプラクティス」を調査

□ Step 6: ライブラリ・フレームワークのバージョン確認
  - AI学習時期 vs 実プロジェクト が異なる場合は Context7 で確認
  - 特に Svelte 5（Runes）は Svelte MCP で最新仕様確認

□ Step 7: Critical Rules の最終確認
  - 削除・代替・ESLint違反が含まれていないか
  - テンプレート制約に違反していないか
  - 例外に該当するか確認
```

→ 上記をすべて完了したら：
  「実装開始前プロセス完了。以下の内容で進めます: [確認結果サマリ]」
  と出力してから実装開始

---

## MCP優先使用ルール

このプロジェクトでは以下の MCP が利用可能です。
**存在する場合は率先して使用すること。**

### Serena

**用途**: コードベースの構造把握、セマンティック検索

**使用タイミング:**
- プロジェクト構造の把握（`tree` コマンドの代わり）
- クラス、関数、シンボルの検索
- コードベース全体の理解

### Context7

**用途**: ライブラリ・フレームワークのドキュメント、ベストプラクティス検索

**使用タイミング:**
- コアの処理や共通処理を実装する前
- AI が学習していないバージョンのライブラリを使う場合
- ベストプラクティスを確認したい場合
- 特別なコードパターンを実装する前

**重要**: 必ず調べてから実装すること

### Playwright

**用途**: ブラウザ自動化、UI の動作確認

**使用タイミング:**
- UI 作成時の動作確認（必須）
- E2E テスト
- ブラウザでの挙動確認

### Encore MCP

**用途**: Encore.dev API の呼び出し、エンドポイントテスト

**使用タイミング:**
- Backend API の動作確認
- 認証フローのテスト
- エンドポイントの統合テスト

### Svelte MCP

**用途**: Svelte 5 の仕様確認、コンポーネントの検証

**使用タイミング:**
- Svelte 5 Runes の使用方法確認
- SvelteKit の最新機能確認
- コンポーネント実装パターンの確認

### MCPの優先順位

1. **Serena**: プロジェクト構造の把握・コード検索
2. **Context7**: ライブラリのドキュメント・ベストプラクティス確認
3. **Svelte / Encore**: 技術スタック別の仕様確認
4. **Playwright**: UI 動作確認

### 標準的な実装フロー

1. **Serena** でプロジェクト構造を把握
2. **Context7** で使用ライブラリのドキュメントを確認
3. **Svelte / Encore** で技術スタック別の仕様を確認
4. 実装
5. **Playwright / Encore** で動作確認

---

## 技術スタック

このプロジェクトでは以下の技術スタックを採用しています。

### Backend

- **Encore.dev**: v1.51.4
  - TypeScript ベースのバックエンドフレームワーク
  - マイクロサービスアーキテクチャ
- **PostgreSQL**: 14+
  - 物理データベース分離（auth, app, notification, dev_tools）
- **Sentry**: v8.55.0
  - エラー監視・ログ収集

### Frontend

- **SvelteKit**: v2.47.1
  - フルスタックWebフレームワーク
- **Svelte**: 5.41.0
  - **Runes** 構文（`$state`, `$derived`, `$effect`）
- **DaisyUI**: v5.4.3
  - UIコンポーネントライブラリ
- **Tailwind CSS**: v4.1.14
  - ユーティリティファーストCSSフレームワーク
- **Sentry**: v8.55.0
  - エラー監視・ログ収集

### 共通

- **TypeScript**: 型安全な開発
- **Node.js**: 実行環境

**重要**: これらのバージョンは変更してはいけません（CRITICAL RULE #3）

---

## プロジェクト構成

```
project-root/
├── backend/                    # Encore.dev TypeScript バックエンド
│   ├── services/              # マイクロサービス群
│   │   ├── auth/              # 認証サービス（auth.auth_users）
│   │   ├── app/               # 業務サービス（app_users + ビジネスロジック）
│   │   ├── notification/      # 通知サービス
│   │   └── dev_tools/         # 開発ツール
│   └── shared/               # 共通モジュール（errors, monitoring）
│
├── frontend-admin/             # 管理画面 (SvelteKit)
│   ├── src/
│   │   ├── lib/              # ライブラリ（API, errors, stores, components）
│   │   └── routes/           # ページルート
│   └── package.json
│
├── frontend-user/              # ユーザー向け画面 (SvelteKit)
│   ├── src/
│   │   ├── lib/              # ライブラリ（API, errors, stores）
│   │   └── routes/           # ページルート
│   └── package.json
│
├── packages/                   # 共通パッケージ (pnpm workspace)
│   └── shared/               # 共通モジュール
│       ├── errors/           # エラー型・変換・コード
│       ├── stores/           # Svelte stores
│       ├── auth/             # 認証ヘルパー
│       └── types/            # 共通型定義
│
├── pnpm-workspace.yaml        # pnpm workspace 設定
├── CLAUDE.md                  # 開発ルール・制限事項（本ドキュメント）
├── ACCELERATOR.md             # 機能説明・アーキテクチャ
├── docs/
│   └── FRONTEND_SEPARATION_PLAN.md  # Frontend分離計画
└── README.md                  # プロジェクト概要
```

### Frontend 分離構成

このプロジェクトでは、管理画面（frontend-admin）とユーザー向け画面（frontend-user）を分離しています：

| ディレクトリ | 用途 | ポート |
|-------------|------|-------|
| `frontend-admin` | 管理画面 | 5173 |
| `frontend-user` | ユーザー向け画面 | 5174 |
| `packages/shared` | 共通コード | - |

詳細は `docs/FRONTEND_SEPARATION_PLAN.md` を参照してください。

### ユーザー管理の構造

このテンプレートでは2種類のユーザーテーブルを使用します：

- **auth_users**: 認証専用（authサービスが管理、authデータベース内）
- **app_users**: アプリケーション用（appサービスが管理、appデータベース内）
  - auth_usersと同じIDで自動作成
  - 実案件で拡張可能なベーステーブル
  - 基本的なプロフィール編集機能を提供

**重要**: Encoreの仕様上、各サービスのデータベースは物理的に分離されており、サービス間での直接的なテーブル参照はできません。必ずAPIを通じて連携してください。

---

## 例外処理とエスカレーション

### CRITICAL RULES の例外認定フロー

**例外を認める場合（以下すべてに該当）:**

```
├─ ユーザーが「明示的に」削除/変更を指示している？
│   └─ YES → Step 2
├─ かつ、削除理由が以下いずれかか？
│   ├─ セキュリティ脆弱性（報告 + 修正案提示必須）
│   ├─ データ保護法違反対応
│   ├─ 技術的実装不可能証明（代替案提示必須）
│   └─ ユーザー明示的指示（ただし確認メッセージ必須）
└─ 代替案や影響範囲をユーザーに確認した？
    └─ YES → 例外認定、実行可能
```

### 例外対応の報告フォーマット

```markdown
**例外実行報告**

- ルール違反: [どのCritical Ruleか]
- 理由: [セキュリティ/不可能/ユーザー指示]
- 対応内容: [具体的な実行内容]
- 影響範囲: [修正・削除したファイル]
- 代替案/復旧方法: [あれば記述]

**例:**
ルール違反: 削除禁止ルール
理由: ユーザー明示的指示
対応内容: /src/routes/old-feature を削除
影響範囲: UI から該当メニュー削除、リンク削除
代替案: git revert で復旧可能（コミット: abc123）
```

---

## AI 動作の原則

### やるべきこと

- ✅ 各種 md ファイルや対応する skill を必ず読む
- ✅ 不明な点は質問する & **検索**する（Context7, Serena MCP を活用）
- ✅ 既存のパターンを踏襲する
- ✅ コードベースを調査してから実装する

### やってはいけないこと

- ❌ コンテキストなしに推測する
- ❌ 存在しないライブラリを創作する
- ❌ 確認なしに既存コードを削除する
- ❌ AI が学習していない新しいバージョンを勝手に使う（Context7 で確認必須）

---

## まとめ

この CLAUDE.md はプロジェクト全体の基盤となる開発ルールと制限事項を定義しています。

**重要な原則:**

1. 実装前に必ず読む
2. CRITICAL RULES は絶対に守る
3. 疑問がある場合は必ずユーザーに確認
4. 自己判断での省略や変更は絶対に行わない
5. MCP を積極的に活用する

**疑問や不明点がある場合:**

- ユーザーに質問する
- 関連ドキュメント（ACCELERATOR.md, backend/CLAUDE.md, frontend/CLAUDE.md）を参照する
- MCP（Context7, Serena 等）で調査する

**次に読むべきドキュメント:**

- `ACCELERATOR.md`: テンプレートが提供する機能の詳細説明
- `backend/CLAUDE.md`: Backend開発ルール（Backend開発者向け）
- `frontend/CLAUDE.md`: Frontend開発ルール（Frontend開発者向け）
