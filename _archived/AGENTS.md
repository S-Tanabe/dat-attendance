# AGENTS.md - プロジェクトガイドライン

このファイルはAIが最初に読むガイドラインです。

## 1. 絶対的禁止事項（CRITICAL RULES）

### 削除禁止・git checkout禁止ルール
**いかなる理由があっても、エラー修正を理由に機能を削除してはならない。**
**自分がコミットした履歴以外のチェックアウトは行ってはならない**
**新しい要求によって以前のUIや機能を削除してはならない。**

禁止される行為:
- エラーが出た機能の削除
- 自分のコミット履歴以外のcheckout
- 「簡略化」と称した機能減少
- 「リファクタリング」での機能省略
- 一時的な回避としての機能無効化
- 追加に関係のない部分の破壊

必須の対応:
- エラーの根本原因を特定
- 機能を維持したまま修正
- 機能やUIが衝突する場合はサンプル用の別画面を用意
- できない場合は代替実装を提案
- それでも無理なら明確に報告

### ESLintルール違反禁止ルール
**ESLintのルール設定そのものを勝手に変更してはならない**

禁止される行為:
- ESLintのエラーやワーニングの修正を省くためにルール自体を変更してはならない
- `eslint-disable-next-line` は禁止

必須の対応:
- 確実に修正を行う
- 最初にルールを理解して開発する
- 修正はその場限りのコーディングを行わず、他の機能がどの様に実装されているか参考にし適切に修正する
- 修正は機能を破壊しないように細心の注意を払う。影響が出る可能性がある場合はユーザーに相談する。

### 代替手段禁止ルール
**代替手段を勝手に決定してはいけない。**

禁止される行為:
- 定められた以外のバージョンやツールを勝手に切り替えない
  - 例: Tailwind v4をv3に切り替える、mecab-wasmをkuromojiに切り替える
- 新しい要求が来ても以前の実装を上書きしてはならない
- エラーを理由に別の実装に切り替えてはならない

必須の対応:
- 代替手段を勝手に決定してはいけない
- エラーの解消方法を追求する
- エラーが解消できない場合は、代替案を提案しそのメリットやデメリットを説明する
- 自分で解消できないエラーは必ず相談する

---
## 🎯 最重要：開発ルールの理解

### 実装開始前の強制発見・読み込みプロセス

1. **`tree -L 3`でプロジェクト構造を把握。serena等のMCPが利用可能な場合は優先**
2. **実装ディレクトリを特定**
  - **パターン検索**: `app/`, `frontend/`, `backend/`, `api/`, `cli/`, `src/` 等
  - **依存関係ファイルの存在確認**: `package.json`, `requirements.txt`, `Cargo.toml` 等
  - **依存関係ファイル（package.json等）の内容を記憶**
3. **設計ルールの強制読み込み:**
  - **frontend実装ルールは`rules/FRONTEND_DEV_RULE.md`を必ず読む。存在しなければ必ず警告を出し、相談する。**
  - **DB設計ルールは`rules/DB_RULE.md`を必ず読む。存在しなければ必ず警告を出し、相談する。**
4. **技術ガイドの強制読み込み:**
  - **本製品の概要は`PLAN.md`を必ず読む。存在しなければ必ず警告を出し、相談する。**
  - **本製品開発における技術Tipsやガイドライン、AIが学習していない対照バージョンについての重要な情報を`SKILL-*.md`に記述しているので必ず参照する。**
5. **技術制約の明示的確認（技術スタック別）**
6. **共通言語**: 機能名はフロントエンドならroutes直下のフォルダ名か、各page.svelte等のTitleで表現している日本語名を利用する。バックエンドならサービス名のxxxx機能のように伝える。類似している物がある場合は必ず確認を行うこと。


### 存在する場合率先して使うべきMCP

MCP名称は完全一致ではない場合があるので注意。

- **serena** : treeコマンドによる全体構造やコードベースからのセマンティック検索に使用
- **context7** : あらゆる言語やライブラリ、FWの基本的ドキュメントからベストプラクティスまで検索可能。コアの処理や共通処理、共通デザイン、特別なコードは必ず調べてから実行
- **playwright** : ブラウザ自動化ツール。このツールがある場合にUI作成には必ず確認すること。
- **encore-mcp** : encore.devのMCP。このツールがある場合に必ず確認すること。
- **svelte** : svelteのMCP。フロントエンド開発はこのツールがある場合に必ず確認すること。Svelte v5の仕様が確認できる。

## 🛠️ 技術的な規約

### データベース運用の原則
- Encoreサービスは論理的には分割されるが、業務系データベースはすべて Postgres の `app` に統合します。
- スキーマ分割は PostgreSQL の `schema.table` で行い（例: `crm.customer`, `workflow.instruction_template`）、`auth`/`dev_tools`/`notification`/`app` 以外の SQLDatabase を新設してはいけません。
- 既存コードを読む際は `schema.table` で明示的に参照されているかを必ず確認し、旧スキーマ名（例: `public.customers`）が残っていないか `rg` でチェックしてください。

### ツールの選択

- **検索**: `grep` より `ast-grep` や `ripgrep` を優先
- **ファイル操作**: 大量のファイルを扱う場合は `batch` 処理
- **MCP**: 利用可能な場合は積極的に活用

### コード品質 (絶対に守って！)

- **ファイルサイズ**: 500行以下に保つ
- **モジュール性**: 責任ごとに分離

#### フロントエンド: ESLint + svelte-check 設定

**役割分担:**
- **ESLint**: コードスタイル、構文チェック、**type-awareルール**（型情報を活用した高度なチェック）、auto-fix対応
- **svelte-check**: TypeScript型チェック、Svelte固有の検証

**設定方針:**
- `@antfu/eslint-config` を使用（Prettier不要）
- TypeScript: `recommended-type-checked`（**type-aware有効**）
  - **`.ts`ファイル**: 全てのtype-awareルールを適用（warningで開始）
  - **`.svelte`ファイル**: 互換性のないルール（unsafe-*系）のみ無効化、async/await関連は有効
  - **設定ファイル**: 全てのtype-awareルールを無効化
- スタイル: タブインデント、シングルクォート、セミコロン不要
- 段階的修正: 既存エラーと新規type-awareルールはwarningから開始

**type-awareルールの効果:**
- `no-floating-promises`: await忘れによる致命的なバグを防止
- `no-misused-promises`: Promise誤用の検出
- `no-unsafe-*`: 型安全性の向上、実行時エラーの早期発見

**利用可能なコマンド:**
```bash
pnpm run lint        # ESLintチェック（キャッシュ付き）
pnpm run lint:fix    # 自動修正
pnpm run check       # svelte-checkで型チェック
pnpm run validate    # check + lint を実行
pnpm run ci          # validate + build を実行
```

**Pre-commit hooks:**
- husky + lint-staged により、コミット時に自動でlint実行
- ステージされたファイルのみチェック（高速化）

**設定ファイル:**
- `eslint.config.js` - ESLint設定（flat config形式）
- `.editorconfig` - エディタ共通設定
- `.vscode/settings.json` - VS Code統合設定
- `package.json` の `lint-staged` - pre-commit設定

### 環境と実行

- **環境変数**: `.env.example` を参考に `.env.local` を作成
- **ポート管理**: 既に使用中なら kill して再起動（別ポートは使わない）


## 🧪 品質保証

### テスト作成

- 別工程でテストを行います。
- 作業完了報告はencore mcpやplaywright mcpで動作確認後エラーがないことを確認してから報告する事
- encoreやplaywrightでの動作確認は単体テスト的ではなく、利用シーンを想定して行う事

## 📝 ドキュメント更新

### **IMPORTANT** 更新すべきドキュメント

- `README.md` - プロジェクト概要、環境構築手順、技術スタック、ライブラリの説明、機能一覧、更新履歴。機能や仕様、利用しているライブラリ等に変更があったら必ず記述すること。

## 🧠 **IMPORTANT** AI動作の原則

### やるべきこと

- ✅ 各種mdを必ず読む
- ✅ 不明な点は質問する & **検索**する。
- ✅ 既存のパターンを踏襲する

### やってはいけないこと

- ❌ コンテキストなしに推測する
- ❌ 存在しないライブラリを創作する
- ❌ 確認なしに既存コードを削除する
